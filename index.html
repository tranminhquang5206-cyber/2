<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <title>Secret Form ‚Ä¢ I Love You</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <style>
  * {
    box-sizing: border-box;
  }

  body {
    margin: 0;
    padding: 0;
    min-height: 100vh;
    font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;

    /* N·ªÄN PASTEL T∆Ø∆†I + CHUY·ªÇN M√ÄU T·ª™ T·ª™ */
    background: linear-gradient(
      135deg,
      #fee2e2,
      #fce7f3,
      #e0f2fe,
      #fef9c3,
      #fed7aa
    );
    background-size: 400% 400%;
    animation: bgShift 18s ease-in-out infinite;

    color: #f9fafb;
    overflow: hidden;
  }

  @keyframes bgShift {
    0%   { background-position: 0% 50%; }
    50%  { background-position: 100% 50%; }
    100% { background-position: 0% 50%; }
  }

  /* N·ªÄN TR√ÅI TIM CODE (CANVAS) FULL M√ÄN */
  .bg-canvas {
    position: fixed;
    inset: 0;
    width: 100%;
    height: 100%;
    z-index: 0;
    pointer-events: none;
  }

  /* L·ªöP APP: CARD ƒêƒÇNG NH·∫¨P / KEY / C√ÇU H·ªéI ƒê√à L√äN TR√äN */
  .app-layer {
    position: relative;
    z-index: 1;
    min-height: 100vh;
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 16px;
  }

  /* CARD K√çNH M·ªú */
  .card {
    width: 100%;
    max-width: 520px;
    border-radius: 22px;

    background: rgba(15, 23, 42, 0.55);
    border: 1px solid rgba(248, 250, 252, 0.35);

    box-shadow:
      0 26px 70px rgba(15, 23, 42, 0.95),
      0 0 0 1px rgba(15, 23, 42, 0.9);

    backdrop-filter: blur(22px) saturate(150%);
    -webkit-backdrop-filter: blur(22px) saturate(150%);

    padding: 20px 20px 18px;
    box-sizing: border-box;
  }

  .card-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 10px;
    margin-bottom: 12px;
    padding-bottom: 4px;
  }

  .card-brand {
    display: flex;
    align-items: center;
    gap: 10px;
  }

  .window-dots {
    display: flex;
    gap: 4px;
  }

  .window-dot {
    width: 9px;
    height: 9px;
    border-radius: 999px;
  }

  .window-dot:nth-child(1) { background: #fb7185; }
  .window-dot:nth-child(2) { background: #facc15; }
  .window-dot:nth-child(3) { background: #22c55e; }

  .card-title-text {
    display: flex;
    flex-direction: column;
    gap: 2px;
  }

  .card-title-main {
    font-size: 15px;
    font-weight: 600;
    color: #f9fafb;
  }

  .card-title-sub {
    font-size: 11px;
    color: #e5e7eb;
    text-transform: uppercase;
    letter-spacing: 0.18em;
  }

  .badge {
    font-size: 12px;
    padding: 4px 10px;
    border-radius: 999px;
    border: 1px solid rgba(248, 250, 252, 0.55);
    color: #f9fafb;
    background: rgba(15, 23, 42, 0.95);
    white-space: nowrap;
  }

  .card-divider {
    height: 1px;
    width: 100%;
    background: linear-gradient(
      90deg,
      rgba(248, 250, 252, 0.0),
      rgba(248, 250, 252, 0.55),
      rgba(248, 250, 252, 0.0)
    );
    margin-bottom: 12px;
    opacity: 0.95;
  }

  .subtitle {
    margin: 0 0 12px;
    font-size: 13px;
    color: #f9fafb;
    line-height: 1.6;
  }

  /* C√ÅC SCREEN */
  .screen {
    display: none;
    background: transparent;
  }

  .screen.active {
    display: block;
    animation: fadeIn 0.25s ease;
  }

  @keyframes fadeIn {
    from {
      opacity: 0;
      transform: translateY(6px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  .screen-title {
    font-size: 15px;
    font-weight: 600;
    margin-bottom: 6px;
    color: #fef9c3;
  }

  .field-block {
    margin-bottom: 14px;
  }

  .q-label {
    font-size: 15px;
    margin-bottom: 4px;
    font-weight: 600;
    color: #fee2e2;
  }

  .q-desc {
    font-size: 13px;
    margin-bottom: 8px;
    color: #e5e7eb;
  }

  .q-count {
    font-size: 12px;
    color: #cbd5f5;
    margin-bottom: 6px;
    text-transform: uppercase;
    letter-spacing: 0.09em;
  }

  input[type="text"],
  input[type="password"],
  textarea {
    width: 100%;
    border-radius: 12px;
    border: 1px solid rgba(148, 163, 184, 0.9);
    padding: 9px 11px;
    font-size: 14px;
    outline: none;
    background: rgba(15, 23, 42, 0.85);
    color: #f9fafb;
    transition: border 0.15s ease, box-shadow 0.15s ease, background 0.15s ease, transform 0.08s ease;
  }

  input::placeholder,
  textarea::placeholder {
    color: #cbd5f5;
  }

  input[type="text"]:focus,
  input[type="password"]:focus,
  textarea:focus {
    border-color: #fb7185;
    box-shadow:
      0 0 0 1px rgba(251, 113, 133, 0.9),
      0 0 18px rgba(251, 113, 133, 0.6);
    background: rgba(15, 23, 42, 0.98);
    transform: translateY(-0.5px);
  }

  textarea {
    min-height: 80px
    max-height: 180px;
    resize: vertical;
  }

  .note {
    font-size: 12px;
    color: #e5e7eb;
    margin-top: 4px;
  }

  .hint {
    font-size: 12px;
    color: #fb7185;
    margin-top: 4px;
    display: block;
  }

  .link {
    font-size: 12px;
    border: none;
    padding: 0;
    margin: 0 4px 0 0;
    background: none;
    color: #f97316;
    text-decoration: underline;
    cursor: pointer;
  }

  .error {
    margin-top: 5px;
    font-size: 12px;
    color: #fecaca;
    display: none;
  }

  .error.show {
    display: block;
  }

  .small-note {
    margin-top: 10px;
    font-size: 12px;
    color: #e5e7eb;
    line-height: 1.5;
  }

  .buttons {
    display: flex;
    justify-content: space-between;
    gap: 10px;
    margin-top: 16px;
  }

  .btn {
    border: none;
    border-radius: 999px;
    padding: 9px 0;
    font-size: 14px;
    font-weight: 600;
    cursor: pointer;
    transition:
      transform 0.12s ease,
      box-shadow 0.12s ease,
      background 0.2s ease,
      opacity 0.12s ease;
  }

  .btn-primary {
    background: linear-gradient(135deg, #fb7185, #f97316);
    color: #f9fafb;
    box-shadow:
      0 10px 26px rgba(248, 113, 113, 0.7),
      0 0 18px rgba(248, 113, 113, 0.7);
  }

  .btn-primary:hover {
    transform: translateY(-1px);
    box-shadow:
      0 12px 30px rgba(248, 113, 113, 0.9),
      0 0 22px rgba(248, 113, 113, 0.9);
  }

  .btn-secondary {
    background: rgba(15, 23, 42, 0.9);
    color: #f9fafb;
    border: 1px solid rgba(148, 163, 184, 0.9);
  }

  .btn-secondary:hover {
    background: rgba(15, 23, 42, 1);
    border-color: #e5e7eb;
    box-shadow: 0 6px 18px rgba(15, 23, 42, 0.7);
  }

  .btn:disabled {
    opacity: 0.55;
    cursor: default;
    transform: none;
    box-shadow: none;
  }

  .btn-full {
    width: 100%;
  }

  .btn-half {
    flex: 1;
  }

  .hidden {
    display: none !important;
  }

  /* PROGRESS + DOTS */
  .progress-bar {
    width: 100%;
    height: 4px;
    border-radius: 999px;
    background: rgba(15, 23, 42, 0.85);
    overflow: hidden;
    margin: 4px 0 10px;
    border: 1px solid rgba(148, 163, 184, 0.9);
  }

  .progress-inner {
    height: 100%;
    width: 0%;
    background: linear-gradient(90deg, #fb7185, #f97316, #facc15);
    transition: width 0.25s ease;
  }

  .steps {
    display: flex;
    justify-content: flex-start;
    gap: 6px;
    margin-bottom: 10px;
  }

  .step-dot {
    width: 9px;
    height: 9px;
    border-radius: 999px;
    background: rgba(15, 23, 42, 0.9);
    border: 1px solid #cbd5f5;
    transition: all 0.2s ease;
  }

  .step-dot.active {
    width: 22px;
    background: #fb7185;
    border-color: transparent;
  }

  .question {
    display: none;
  }

  .question.active {
    display: block;
    animation: qSlide 0.25s ease;
  }

  @keyframes qSlide {
    from { opacity: 0; transform: translateX(14px); }
    to   { opacity: 1; transform: translateX(0); }
  }

  .done-message {
    display: none;
    padding-top: 4px;
  }

  .done-message.show {
    display: block;
    animation: fadeIn 0.25s ease;
  }

  .done-message h2 {
    font-size: 16px;
    margin-bottom: 6px;
    color: #fef9c3;
  }

  .done-message p {
    font-size: 13px;
    color: #e5e7eb;
    margin: 0;
  }

  @media (max-width: 640px) {
    .card {
      max-width: 100%;
      padding: 16px 14px 14px;
    }

    .card-title-main {
      font-size: 14px;
    }

    .q-label {
      font-size: 14px;
    }
  }
  </style>
</head>
<body>
  <!-- N·ªÄN TR√ÅI TIM V·∫º B·∫∞NG CODE -->
  <canvas id="heartCanvas" class="bg-canvas"></canvas>

  <!-- NH·∫†C N·ªÄN: T·ª∞ PH√ÅT -->
  <audio id="bgMusic" autoplay loop>
    <source src="music.mp3" type="audio/mpeg" />
  </audio>

  <!-- APP: CARD ƒêƒÇNG NH·∫¨P / KEY / C√ÇU H·ªéI -->
  <div class="app-layer">
    <div class="card">
      <div class="card-header">
        <div class="card-brand">
          <div class="window-dots">
            <div class="window-dot"></div>
            <div class="window-dot"></div>
            <div class="window-dot"></div>
          </div>
          <div class="card-title-text">
            <div class="card-title-main">Secret form</div>
            <div class="card-title-sub">private session</div>
          </div>
        </div>
        <span class="badge">Private ‚Ä¢ 1:1</span>
      </div>

      <div class="card-divider"></div>

      <!-- LOGIN SCREEN -->
      <div id="loginScreen" class="screen active">
        

        <form id="loginForm">
          <div class="field-block" id="usernameSection">
            <div class="screen-title">B∆∞·ªõc 1 ¬∑ T√™n ƒëƒÉng nh·∫≠p</div>
            <input type="text" id="usernameInput" placeholder="G√µ t√™n ƒëƒÉng nh·∫≠p m√† em ƒëo√°n..." />
            <div class="note">
              C√≤n <span id="userAttemptsLeft">5</span> l·∫ßn ƒëo√°n t√™n.
            </div>
            <div class="hint hidden" id="userHintDynamic"></div>
          </div>

          <div class="field-block hidden" id="passwordSection">
            <div class="screen-title">B∆∞·ªõc 2 ¬∑ M·∫≠t kh·∫©u</div>
            <input type="password" id="passwordInput" placeholder="G√µ m·∫≠t kh·∫©u b√≠ m·∫≠t..." />
            <div class="note">
              C√≤n <span id="passAttemptsLeft">5</span> l·∫ßn ƒëo√°n m·∫≠t kh·∫©u.
            </div>
            <div class="hint hidden" id="passHintDynamic"></div>
          </div>

          <div class="error" id="loginError"></div>

          <button type="submit" class="btn btn-primary btn-full" id="loginButton" style="margin-top: 10px;">
            X√°c nh·∫≠n t√™n
          </button>

          <div class="small-note">
            *N·∫øu sai qu√° s·ªë l·∫ßn cho ph√©p, h·ªá th·ªëng kh√≥a t·∫°m v√† y√™u c·∫ßu KEY ƒë·ªÉ m·ªü l·∫°i.
          </div>
        </form>
      </div>

      <!-- KEY SCREEN -->
      <div id="keyScreen" class="screen">
        <div class="screen-title">Kh√≥a b·∫£o m·∫≠t</div>
        <p class="subtitle" id="lockReasonText">
          Em ƒë√£ nh·∫≠p sai qu√° s·ªë l·∫ßn cho ph√©p r·ªìi, h√£y suy nghƒ© kƒ© v√† tr√¢n tr·ªçng m·ªói l·∫ßn nh·∫≠p nh√©.<br />
          Mu·ªën ch∆°i l·∫°i t·ª´ ƒë·∫ßu th√¨ em ph·∫£i nh·∫≠p ƒë√∫ng <strong>KEY b√≠ m·∫≠t</strong>.
        </p>

        <form id="keyForm">
          <div class="field-block">
            <div class="q-label">KEY b√≠ m·∫≠t</div>
            <input type="text" id="keyInput" placeholder="G√µ KEY ·ªü ƒë√¢y..." />
            <div class="note">
              G·ª£i √Ω:
              <button type="button" class="link" id="keyHintToggle">Hi·ªán g·ª£i √Ω</button>
              <span id="keyHintText" class="hint hidden">
                V√≠ d·ª•: Ng√†y ch√∫ng m√¨nh g·∫∑p nhau l√† ng√†y n√†o em 
              </span>
            </div>
          </div>

          <div class="error" id="keyError"></div>

          <button type="submit" class="btn btn-primary btn-full" style="margin-top: 8px;">
            M·ªü kh√≥a l·∫°i
          </button>

          <div class="small-note">
            *KEY kh√¥ng gi·ªõi h·∫°n s·ªë l·∫ßn, nh∆∞ng ph·∫£i ƒë√∫ng m·ªõi m·ªü ƒë∆∞·ª£c.
          </div>
        </form>
      </div>

            <!-- QUESTION SCREEN -->
      <div id="questionScreen" class="screen">
        <div class="screen-title">H·ªôp th∆∞ b√≠ m·∫≠t</div>
        <p class="subtitle">
          Qua ƒë∆∞·ª£c c·ªïng b·∫£o m·∫≠t r·ªìi, gi·ªù tr·∫£ l·ªùi thi·ªát l√≤ng nha.
        </p>

        <div class="progress-bar">
          <div class="progress-inner" id="progressInner"></div>
        </div>

        <!-- ƒê√É ƒê·ªîI TH√ÄNH 6 CH·∫§M -->
        <div class="steps">
          <div class="step-dot active"></div>
          <div class="step-dot"></div>
          <div class="step-dot"></div>
          <div class="step-dot"></div>
          <div class="step-dot"></div>
          <div class="step-dot"></div>
        </div>

        <form id="secretForm">
          <!-- C√ÇU 1 -->
          <div class="question active" data-step="1">
            <div class="q-count">C√¢u 1 / 6</div>
            <div class="q-label">·∫§n t∆∞·ª£ng ƒë·∫ßu ti√™n c·ªßa em v·ªÅ anh l√† g√¨?</div>
            <div class="q-desc">N√≥i thi·ªát ƒëi, anh kh√¥ng gi·∫≠n.</div>
            <textarea name="q1" placeholder="Ghi g√¨ ƒë√≥ v√†o ƒë√¢y..."></textarea>
            <div class="error">C√¢u n√†y ch∆∞a tr·∫£ l·ªùi k√¨a.</div>
          </div>

          <!-- C√ÇU 2 -->
          <div class="question" data-step="2">
            <div class="q-count">C√¢u 2 / 6</div>
            <div class="q-label">ƒêi·ªÅu g√¨ ·ªü anh l√†m em th·∫•y d·ªÖ ch·ªãu nh·∫•t?</div>
            <div class="q-desc">T√≠nh c√°ch, c√°ch n√≥i chuy·ªán, nƒÉng l∆∞·ª£ng... hay c√°i g√¨ kh√°c?</div>
            <textarea name="q2" placeholder="K·ªÉ nh·∫π c≈©ng ƒë∆∞·ª£c."></textarea>
            <div class="error">C√¢u n√†y ch∆∞a tr·∫£ l·ªùi k√¨a.</div>
          </div>

          <!-- C√ÇU 3 -->
          <div class="question" data-step="3">
            <div class="q-count">C√¢u 3 / 6</div>
            <div class="q-label">C√≥ ƒëi·ªÅu g√¨ em mu·ªën n√≥i nh∆∞ng ng·∫°i n√≥i tr·ª±c ti·∫øp kh√¥ng?</div>
            <div class="q-desc">Coi nh∆∞ b√≠ m·∫≠t gi·ªØa hai ƒë·ª©a.</div>
            <textarea name="q3" placeholder="Chuy·ªán g√¨ c≈©ng ƒë∆∞·ª£c, mi·ªÖn th·∫≠t."></textarea>
            <div class="error">C√¢u n√†y ch∆∞a tr·∫£ l·ªùi k√¨a.</div>
          </div>

          <!-- C√ÇU 4 -->
          <div class="question" data-step="4">
            <div class="q-count">C√¢u 4 / 6</div>
            <div class="q-label">N·∫øu anh r·ªß em ƒëi ch∆°i, em th√≠ch ƒëi ƒë√¢u nh·∫•t?</div>
            <div class="q-desc">Cafe, bi·ªÉn, xem phim, ƒëi d·∫°o... hay ·ªü nh√† ng·ªß?</div>
            <input type="text" name="q4" placeholder="Ghi n∆°i em mu·ªën ƒë∆∞·ª£c r·ªß ƒëi..." />
            <div class="error">C√¢u n√†y ch∆∞a tr·∫£ l·ªùi k√¨a.</div>
          </div>

          <!-- C√ÇU 5 -->
          <div class="question" data-step="5">
            <div class="q-count">C√¢u 5 / 6</div>
            <div class="q-label">M·ªôt ƒëi·ªÅu em mu·ªën anh thay ƒë·ªïi ho·∫∑c c·∫£i thi·ªán?</div>
            <div class="q-desc">N√≥i thi·ªát c≈©ng ƒë∆∞·ª£c, anh ch·ªãu nghe.</div>
            <textarea name="q5" placeholder="G√≥p √Ω nh·∫π nh√†ng th√¥i nha."></textarea>
            <div class="error">C√¢u n√†y ch∆∞a tr·∫£ l·ªùi k√¨a.</div>
          </div>

          <!-- C√ÇU 6 ƒê·∫∂C BI·ªÜT -->
          <div class="question" data-step="6">
            <div class="q-count">C√¢u 6 / 6</div>
            <div class="q-label">
              N·∫øu c√≥ m·ªôt ng√†y anh ƒë·ªôt nhi√™n bi·∫øn m·∫•t, em c√≥ ƒëi t√¨m anh kh√¥ng...?
            </div>
            <div class="q-desc">Tr·∫£ l·ªùi th·∫≠t l√≤ng nha, kh√¥ng c·∫ßn vƒÉn v·∫ª.</div>
            <textarea name="q6" placeholder="Em s·∫Ω l√†m g√¨ n·∫øu m·ªôt ng√†y kh√¥ng c√≤n th·∫•y anh?"></textarea>
            <div class="error">C√¢u n√†y ch∆∞a tr·∫£ l·ªùi k√¨a.</div>
          </div>

          <div class="buttons">
            <button type="button" class="btn btn-secondary btn-half" id="prevBtn">
              Quay l·∫°i
            </button>
            <button type="button" class="btn btn-primary btn-half" id="nextBtn">
              Ti·∫øp theo
            </button>
            <button type="submit" class="btn btn-primary btn-half hidden" id="submitBtn">
              G·ª≠i b√≠ m·∫≠t
            </button>
          </div>

          <div class="small-note">
            *C√¢u tr·∫£ l·ªùi s·∫Ω ƒë∆∞·ª£c g·ª≠i ·∫©n danh v√† l∆∞u v√†o Google Sheets.
          </div>
        </form>

        <div class="done-message" id="doneMessage">
          <h2>ƒê√£ nh·∫≠n b√≠ m·∫≠t c·ªßa em r·ªìi ü´£</h2>
          <p>D·ªØ li·ªáu ƒë√£ g·ª≠i v·ªÅ Google Sheets qua Apps Script.</p>
        </div>
      </div>


  <!-- SCRIPT 1: N·ªÄN TR√ÅI TIM B·∫∞NG CODE -->
  <script>
    (function () {
      const canvas = document.getElementById("heartCanvas");
      if (!canvas || !canvas.getContext) return;
      const ctx = canvas.getContext("2d");

      const cfg = {
        particles: {
          length: 600,
          duration: 2,
          velocity: 100,
          effect: -0.75,
          size: 36
        }
      };

      class Point {
        constructor(x, y) {
          this.x = typeof x !== "undefined" ? x : 0;
          this.y = typeof y !== "undefined" ? y : 0;
        }
        clone() {
          return new Point(this.x, this.y);
        }
        length(length) {
          if (typeof length === "undefined") {
            return Math.sqrt(this.x * this.x + this.y * this.y);
          }
          this.normalize();
          this.x *= length;
          this.y *= length;
          return this;
        }
        normalize() {
          const len = this.length();
          this.x /= len;
          this.y /= len;
          return this;
        }
      }

      class Particle {
        constructor() {
          this.position = new Point();
          this.velocity = new Point();
          this.accel = new Point();
          this.age = 0;
        }
        init(x, y, dx, dy) {
          this.position.x = x;
          this.position.y = y;
          this.velocity.x = dx;
          this.velocity.y = dy;
          this.accel.x = dx * cfg.particles.effect;
          this.accel.y = dy * cfg.particles.effect;
          this.age = 0;
        }
        update(dt) {
          this.position.x += this.velocity.x * dt;
          this.position.y += this.velocity.y * dt;
          this.velocity.x += this.accel.x * dt;
          this.velocity.y += this.accel.y * dt;
          this.age += dt;
        }
        draw(context, image) {
          function ease(t) {
            return (--t) * t * t + 1;
          }
          const life = this.age / cfg.particles.duration;
          const size = image.width * ease(life);
          context.globalAlpha = 1 - life;
          context.drawImage(
            image,
            this.position.x - size / 2,
            this.position.y - size / 2,
            size,
            size
          );
        }
      }

      class ParticlePool {
        constructor(length) {
          this.particles = new Array(length);
          for (let i = 0; i < this.particles.length; i++) {
            this.particles[i] = new Particle();
          }
          this.firstActive = 0;
          this.firstFree = 0;
          this.duration = cfg.particles.duration;
        }
        add(x, y, dx, dy) {
          this.particles[this.firstFree].init(x, y, dx, dy);

          this.firstFree++;
          if (this.firstFree === this.particles.length) this.firstFree = 0;
          if (this.firstActive === this.firstFree) {
            this.firstActive++;
            if (this.firstActive === this.particles.length) this.firstActive = 0;
          }
        }
        update(dt) {
          let i;

          if (this.firstActive < this.firstFree) {
            for (i = this.firstActive; i < this.firstFree; i++) {
              this.particles[i].update(dt);
            }
          } else if (this.firstFree < this.firstActive) {
            for (i = this.firstActive; i < this.particles.length; i++) {
              this.particles[i].update(dt);
            }
            for (i = 0; i < this.firstFree; i++) {
              this.particles[i].update(dt);
            }
          }

          while (
            this.firstActive !== this.firstFree &&
            this.particles[this.firstActive].age >= this.duration
          ) {
            this.firstActive++;
            if (this.firstActive === this.particles.length) this.firstActive = 0;
          }
        }
        draw(context, image) {
          let i;
          if (this.firstActive < this.firstFree) {
            for (i = this.firstActive; i < this.firstFree; i++) {
              this.particles[i].draw(context, image);
            }
          } else if (this.firstFree < this.firstActive) {
            for (i = this.firstActive; i < this.particles.length; i++) {
              this.particles[i].draw(context, image);
            }
            for (i = 0; i < this.firstFree; i++) {
              this.particles[i].draw(context, image);
            }
          }
        }
      }

      const HEART_SCALE = 1.2;

      function pointOnHeart(t) {
        return new Point(
          HEART_SCALE * 160 * Math.pow(Math.sin(t), 3),
          HEART_SCALE * (
            130 * Math.cos(t) -
            50 * Math.cos(2 * t) -
            20 * Math.cos(3 * t) -
            10 * Math.cos(4 * t) +
            25
          )
        );
      }

      const particleImage = (() => {
        const c = document.createElement("canvas");
        const cctx = c.getContext("2d");
        c.width = cfg.particles.size;
        c.height = cfg.particles.size;

        function toCanvasPoint(t) {
          const p = pointOnHeart(t);
          p.x = cfg.particles.size / 2 + (p.x * cfg.particles.size) / 350;
          p.y = cfg.particles.size / 2 - (p.y * cfg.particles.size) / 350;
          return p;
        }

        cctx.beginPath();
        let t = -Math.PI;
        let p = toCanvasPoint(t);
        cctx.moveTo(p.x, p.y);
        while (t < Math.PI) {
          t += 0.01;
          p = toCanvasPoint(t);
          cctx.lineTo(p.x, p.y);
        }
        cctx.closePath();
        const grad = cctx.createLinearGradient(0, 0, c.width, c.height);
        grad.addColorStop(0, "#fb7185");
        grad.addColorStop(1, "#f97316");
        cctx.fillStyle = grad;
        cctx.fill();

        const img = new Image();
        img.src = c.toDataURL();
        return img;
      })();

      const pool = new ParticlePool(cfg.particles.length);
      const rate = cfg.particles.length / cfg.particles.duration;
      let time;

      function render() {
        requestAnimationFrame(render);

        const newTime = Date.now() / 1000;
        const dt = newTime - (time || newTime);
        time = newTime;

        ctx.clearRect(0, 0, canvas.width, canvas.height);

        const amount = rate * dt;
        for (let i = 0; i < amount; i++) {
          const pos = pointOnHeart(Math.PI - 2 * Math.PI * Math.random());
          const dir = pos.clone().length(cfg.particles.velocity);

          pool.add(
            canvas.width / 2 + pos.x,
            canvas.height / 2 - pos.y,
            dir.x,
            -dir.y
          );
        }

        pool.update(dt);
        pool.draw(ctx, particleImage);
      }

      function onResize() {
        canvas.width = canvas.clientWidth;
        canvas.height = canvas.clientHeight;
      }

      window.addEventListener("resize", onResize);
      setTimeout(() => {
        onResize();
        render();
      }, 10);
    })();
  </script>

  <!-- SCRIPT 2: LOGIN / KEY / C√ÇU H·ªéI / G·ª¨I GOOGLE SHEETS -->
  <script>
    /* ========== C·∫§U H√åNH ƒêƒÇNG NH·∫¨P ========== */
    const CORRECT_USERNAME = "betathanhxuan";      // ‚Üê S·ª¨A USER ·ªû ƒê√ÇY
    const CORRECT_PASSWORD = "404";   // ‚Üê S·ª¨A PASS ·ªû ƒê√ÇY
    const UNLOCK_KEY       = "1010";  // ‚Üê S·ª¨A KEY ·ªû ƒê√ÇY

    const MAX_USERNAME_ATTEMPTS = 5;
    const MAX_PASSWORD_ATTEMPTS = 5;

    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycby4khlF73OTRKPczEc8CHMOaMk_LmxbshPGSqvhxTZ52JgqvCioUvKSER2KjKVRUbXr/exec";

    // G·ª¢I √ù USER / PASS M·ªñI L·∫¶N NH·∫¨P SAI
    const USER_HINTS = [
      "G·ª£i √Ω 1: T√™n ƒëƒÉng nh·∫≠p li√™n quan t·ªõi em.",
      "G·ª£i √Ω 2: Ch·ªØ c√°i c√≥ trong t√™n l√† l√† 't'.",
      "G·ª£i √Ω 3: Kh√¥ng c√≥ d·∫•u, to√†n ch·ªØ th∆∞·ªùng.",
      "G·ª£i √Ω 4: N∆°i n√†y ƒë√°nh d·∫•u r·∫•t nhi·ªÅu l·∫ßn ƒë·∫ßu ti√™n c·ªßa ch√∫ng m√¨nh.",
      "G·ª£i √Ω 5: N·∫øu v·∫´n ch∆∞a ra th√¨ inbox anh üôÉ"
    ];

    const PASS_HINTS = [
      "G·ª£i √Ω 1: Pass n√†y ch·ª©a nguy√™n s·ªë.",
      "G·ª£i √Ω 2: Ch·ªâ c√≥ 3 s·ªë.",
      "G·ª£i √Ω 3: Kh√¥ng ph·∫£i ng√†y th√°ng g√¨ ƒë√¢u em ·∫°.",
      "G·ª£i √Ω 4: N√≥ c√≥ g·∫Øn v·ªõi m·ªôt l·∫ßn ƒë·∫ßu ti√™n c·ªßa ch√∫ng m√¨nh.",
      "G·ª£i √Ω 5: Em nghƒ© kƒ© l·∫°i c√≥ l·∫ßn ƒë·∫ßu ti√™n n√†o c·ªßa ch√∫ng m√¨nh c√≥ con s·ªë kh√¥ng."
    ];

    const loginScreen     = document.getElementById("loginScreen");
    const keyScreen       = document.getElementById("keyScreen");
    const questionScreen  = document.getElementById("questionScreen");

    const loginForm       = document.getElementById("loginForm");
    const usernameInput   = document.getElementById("usernameInput");
    const passwordInput   = document.getElementById("passwordInput");
    const loginError      = document.getElementById("loginError");
    const userAttemptsEl  = document.getElementById("userAttemptsLeft");
    const passAttemptsEl  = document.getElementById("passAttemptsLeft");
    const usernameSection = document.getElementById("usernameSection");
    const passwordSection = document.getElementById("passwordSection");
    const loginButton     = document.getElementById("loginButton");

    const lockReasonText  = document.getElementById("lockReasonText");
    const keyForm         = document.getElementById("keyForm");
    const keyInput        = document.getElementById("keyInput");
    const keyError        = document.getElementById("keyError");
    const keyHintToggle   = document.getElementById("keyHintToggle");
    const keyHintText     = document.getElementById("keyHintText");

    const userHintDynamic = document.getElementById("userHintDynamic");
    const passHintDynamic = document.getElementById("passHintDynamic");

    const questions       = document.querySelectorAll(".question");
    const dots            = document.querySelectorAll(".step-dot");
    const prevBtn         = document.getElementById("prevBtn");
    const nextBtn         = document.getElementById("nextBtn");
    const submitBtn       = document.getElementById("submitBtn");
    const form            = document.getElementById("secretForm");
    const doneMessage     = document.getElementById("doneMessage");
    const progressInner   = document.getElementById("progressInner");

    const bgMusic         = document.getElementById("bgMusic");

    let currentStep = 0;
    let loginPhase = "username";

    /* ========== NH·∫†C N·ªÄN: AUTOPLAY + FALLBACK CLICK ========== */
    if (bgMusic) {
      bgMusic.volume = 0.35;
      bgMusic.play().catch(() => {
        const resume = () => {
          bgMusic.play().catch(() => {});
          window.removeEventListener("click", resume);
        };
        window.addEventListener("click", resume);
      });
    }

    /* ========== SWITCH SCREEN ========== */
    function setScreen(name) {
      loginScreen.classList.remove("active");
      keyScreen.classList.remove("active");
      questionScreen.classList.remove("active");

      if (name === "login") {
        loginScreen.classList.add("active");
      } else if (name === "key") {
        keyScreen.classList.add("active");
      } else if (name === "questions") {
        questionScreen.classList.add("active");
      }
    }

    /* ========== QU·∫¢N L√ù S·ªê L·∫¶N TH·ª¨ (D√ôNG KEY M·ªöI ƒê·ªÇ KH√îNG D√çNH D·ªÆ LI·ªÜU C≈®) ========== */
    const USER_ATTEMPTS_KEY = "secret_usernameAttempts_v2";
    const PASS_ATTEMPTS_KEY = "secret_passwordAttempts_v2";
    const LOCK_KEY          = "secretAppLocked_v2";

    let usernameAttempts = parseInt(localStorage.getItem(USER_ATTEMPTS_KEY) || "0", 10);
    if (isNaN(usernameAttempts)) usernameAttempts = 0;

    let passwordAttempts = parseInt(localStorage.getItem(PASS_ATTEMPTS_KEY) || "0", 10);
    if (isNaN(passwordAttempts)) passwordAttempts = 0;

    function saveAttempts() {
      localStorage.setItem(USER_ATTEMPTS_KEY, String(usernameAttempts));
      localStorage.setItem(PASS_ATTEMPTS_KEY, String(passwordAttempts));
    }

    function updateAttemptsUI() {
      if (userAttemptsEl) {
        const leftUser = Math.max(0, MAX_USERNAME_ATTEMPTS - usernameAttempts);
        userAttemptsEl.textContent = leftUser;
      }
      if (passAttemptsEl) {
        const leftPass = Math.max(0, MAX_PASSWORD_ATTEMPTS - passwordAttempts);
        passAttemptsEl.textContent = leftPass;
      }
    }

    function clearHints() {
      if (userHintDynamic) {
        userHintDynamic.textContent = "";
        userHintDynamic.classList.add("hidden");
      }
      if (passHintDynamic) {
        passHintDynamic.textContent = "";
        passHintDynamic.classList.add("hidden");
      }
    }

    function lockApp(reason) {
      localStorage.setItem(LOCK_KEY, "1");

      if (reason === "username") {
        lockReasonText.innerHTML =
          "Em nh·∫≠p sai <strong>t√™n ƒëƒÉng nh·∫≠p</strong> h∆°i nhi·ªÅu r·ªìi ƒë√≥.<br />" +
          "Mu·ªën ch∆°i l·∫°i t·ª´ ƒë·∫ßu th√¨ nh·∫≠p ƒë√∫ng <strong>KEY b√≠ m·∫≠t</strong> nha.";
      } else if (reason === "password") {
        lockReasonText.innerHTML =
          "Em nh·∫≠p sai <strong>m·∫≠t kh·∫©u</strong> h∆°i b·ªã nhi·ªÅu l·∫ßn r·ªìi.<br />" +
          "Mu·ªën ch∆°i l·∫°i t·ª´ ƒë·∫ßu th√¨ nh·∫≠p ƒë√∫ng <strong>KEY b√≠ m·∫≠t</strong> nha.";
      } else {
        lockReasonText.innerHTML =
          "Em ƒë√£ nh·∫≠p sai qu√° s·ªë l·∫ßn cho ph√©p r·ªìi, suy nghƒ© kƒ© h∆°n l·∫ßn sau nha.<br />" +
          "Mu·ªën ch∆°i l·∫°i t·ª´ ƒë·∫ßu th√¨ ph·∫£i nh·∫≠p ƒë√∫ng <strong>KEY b√≠ m·∫≠t</strong>.";
      }

      setScreen("key");
    }

    function unlockApp() {
      localStorage.removeItem(LOCK_KEY);
      usernameAttempts = 0;
      passwordAttempts = 0;
      saveAttempts();
      updateAttemptsUI();
      keyInput.value = "";
      keyError.textContent = "";
      keyError.classList.remove("show");
      clearHints();
      setLoginPhase("username");
      setScreen("login");
    }

    function setLoginPhase(phase) {
      loginPhase = phase;

      if (phase === "username") {
        usernameSection.classList.remove("hidden");
        passwordSection.classList.add("hidden");
        loginButton.textContent = "X√°c nh·∫≠n t√™n";
        loginError.textContent = "";
        loginError.classList.remove("show");
        clearHints();
        usernameInput.value = "";
      } else {
        usernameSection.classList.add("hidden");
        passwordSection.classList.remove("hidden");
        loginButton.textContent = "M·ªü c·ªïng b√≠ m·∫≠t";
        loginError.textContent = "";
        loginError.classList.remove("show");
        clearHints();
        passwordInput.value = "";
      }
    }

    /* ========== LOGIN FORM ========== */
    if (loginForm) {
      loginForm.addEventListener("submit", (e) => {
        e.preventDefault();

        if (localStorage.getItem(LOCK_KEY) === "1") {
          setScreen("key");
          return;
        }

        if (loginPhase === "username") {
          const user = usernameInput.value.trim();

          if (!user) {
            loginError.textContent = "Nh·∫≠p t√™n tr∆∞·ªõc ƒë√£.";
            loginError.classList.add("show");
            return;
          }

          if (user !== CORRECT_USERNAME) {
            usernameAttempts++;
            saveAttempts();

            if (usernameAttempts >= MAX_USERNAME_ATTEMPTS) {
              lockApp("username");
              return;
            }

            updateAttemptsUI();
            loginError.textContent = "T√™n ƒëƒÉng nh·∫≠p ch∆∞a ƒë√∫ng, th·ª≠ l·∫°i nha.";
            loginError.classList.add("show");

            const idx = usernameAttempts - 1;
            if (USER_HINTS[idx] && userHintDynamic) {
              userHintDynamic.textContent = USER_HINTS[idx];
              userHintDynamic.classList.remove("hidden");
            }
          } else {
            clearHints();
            loginError.textContent = "";
            loginError.classList.remove("show");
            setLoginPhase("password");
          }
        } else {
          const pass = passwordInput.value.trim();

          if (!pass) {
            loginError.textContent = "Nh·∫≠p m·∫≠t kh·∫©u tr∆∞·ªõc ƒë√£.";
            loginError.classList.add("show");
            return;
          }

          if (pass !== CORRECT_PASSWORD) {
            passwordAttempts++;
            saveAttempts();

            if (passwordAttempts >= MAX_PASSWORD_ATTEMPTS) {
              lockApp("password");
              return;
            }

            updateAttemptsUI();
            loginError.textContent = "M·∫≠t kh·∫©u ch∆∞a ƒë√∫ng, th·ª≠ l·∫°i nha.";
            loginError.classList.add("show");

            const idx = passwordAttempts - 1;
            if (PASS_HINTS[idx] && passHintDynamic) {
              passHintDynamic.textContent = PASS_HINTS[idx];
              passHintDynamic.classList.remove("hidden");
            }
          } else {
            clearHints();
            loginError.textContent = "";
            loginError.classList.remove("show");
            passwordInput.value = "";
            setScreen("questions");
          }
        }
      });
    }

    /* ========== KEY FORM ========== */
    if (keyForm) {
      keyForm.addEventListener("submit", (e) => {
        e.preventDefault();
        const value = keyInput.value.trim();

        if (!value) {
          keyError.textContent = "Nh·∫≠p KEY tr∆∞·ªõc ƒë√£.";
          keyError.classList.add("show");
          return;
        }

        if (value === UNLOCK_KEY) {
          keyError.textContent = "";
          keyError.classList.remove("show");
          unlockApp();
        } else {
          keyError.textContent = "KEY ch∆∞a ƒë√∫ng, th·ª≠ l·∫°i nha.";
          keyError.classList.add("show");
        }
      });
    }

    if (keyHintToggle && keyHintText) {
      keyHintToggle.addEventListener("click", () => {
        keyHintText.classList.toggle("hidden");
      });
    }

    /* ========== C√ÇU H·ªéI ========== */
    function showStep(index) {
      questions.forEach((q, i) => {
        q.classList.toggle("active", i === index);
      });

      dots.forEach((d, i) => {
        d.classList.toggle("active", i === index);
      });

      const percent = ((index + 1) / questions.length) * 100;
      progressInner.style.width = percent + "%";

      prevBtn.disabled = index === 0;

      if (index === questions.length - 1) {
        nextBtn.classList.add("hidden");
        submitBtn.classList.remove("hidden");
      } else {
        nextBtn.classList.remove("hidden");
        submitBtn.classList.add("hidden");
      }

      const error = questions[index].querySelector(".error");
      if (error) error.classList.remove("show");
    }

    function validateStep(index) {
      const q = questions[index];
      const input = q.querySelector("textarea, input");
      const error = q.querySelector(".error");

      if (!input) return true;

      if (!input.value.trim()) {
        if (error) error.classList.add("show");
        return false;
      } else {
        if (error) error.classList.remove("show");
        return true;
      }
    }

    if (prevBtn) {
      prevBtn.addEventListener("click", () => {
        if (currentStep > 0) {
          currentStep--;
          showStep(currentStep);
        }
      });
    }

    if (nextBtn) {
      nextBtn.addEventListener("click", () => {
        if (!validateStep(currentStep)) return;
        if (currentStep < questions.length - 1) {
          currentStep++;
          showStep(currentStep);
        }
      });
    }

    if (form) {
      form.addEventListener("submit", (e) => {
        e.preventDefault();

        if (!validateStep(currentStep)) return;

        const formData = new FormData(form);
        formData.append("timestamp", new Date().toISOString());

        fetch(SCRIPT_URL, {
          method: "POST",
          body: formData
        })
          .then((res) => res.text())
          .then((text) => {
            console.log("ƒê√£ g·ª≠i Google Sheets:", text);
            form.classList.add("hidden");
            doneMessage.classList.add("show");
          })
          .catch((err) => {
            console.error("L·ªói g·ª≠i Google Sheets:", err);
            form.classList.add("hidden");
            doneMessage.classList.add("show");
          });
      });
    }

    function initApp() {
      updateAttemptsUI();

      const lockedFlag = localStorage.getItem(LOCK_KEY) === "1";
      if (
        lockedFlag ||
        usernameAttempts >= MAX_USERNAME_ATTEMPTS ||
        passwordAttempts >= MAX_PASSWORD_ATTEMPTS
      ) {
        lockApp();
      } else {
        setLoginPhase("username");
        setScreen("login");
      }

      if (questions.length > 0) {
        showStep(currentStep);
      }
    }

    initApp();
  </script>
</body>
</html>
